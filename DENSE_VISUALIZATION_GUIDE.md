# Dense é˜¶æ®µå¯è§†åŒ–å¢å¼ºè¯´æ˜

## ğŸ¨ **æ›´æ–°å†…å®¹**

### æ–°å¢åŠŸèƒ½

é’ˆå¯¹ Dense é˜¶æ®µå¢åŠ äº†å®Œæ•´çš„ 5 å¤´é¢„æµ‹å¯¹æ¯”å¯è§†åŒ–ï¼ŒåŒ…å«æ‰€æœ‰é¢„æµ‹å¤´çš„è¯¦ç»†è¯„ä¼°ã€‚

---

## ğŸ“Š **å¯è§†åŒ–å¯¹æ¯”**

### Structural é˜¶æ®µ (é¢„è®­ç»ƒ)

**åˆ—æ•°**: 6 åˆ—

```
[Input, GT Skel, Pr Skel, GT Tan, Pr Tan, Overlay]
```

**é€‚åˆ**: é¢„è®­ç»ƒé˜¶æ®µåªéœ€å…³æ³¨éª¨æ¶é‡å»ºå’Œåˆ‡å‘åœº

---

### Dense é˜¶æ®µ (å®Œæ•´ç‰ˆ) ğŸ”¥

**åˆ—æ•°**: 16 åˆ—

```
[In, GT Skel, Pr Skel,
 GT KP_T, Pr KP_T,   â† Keypoints Topo (æ‹“æ‰‘èŠ‚ç‚¹)
 GT KP_G, Pr KP_G,    â† Keypoints Geo (å‡ ä½•é”šç‚¹)
 GT Tan, Pr Tan,
 GT W, Pr W,          â† Width (å®½åº¦)
 GT OX, Pr OX,        â† Offset X
 GT OY, Pr OY,        â† Offset Y
 Ovl]                  â† Overlay (ç»¿=GT, çº¢=Pred)
```

**å®Œæ•´å†…å®¹**ï¼š
1. **Input** - è¾“å…¥å›¾åƒ
2. **GT Skeleton** - çœŸå€¼éª¨æ¶
3. **Pred Skeleton** - é¢„æµ‹éª¨æ¶
4. **GT KP Topo** - çœŸå€¼æ‹“æ‰‘å…³é”®ç‚¹ï¼ˆç«¯ç‚¹ã€äº¤å‰ç‚¹ï¼‰
5. **Pred KP Topo** - é¢„æµ‹æ‹“æ‰‘å…³é”®ç‚¹
6. **GT KP Geo** - çœŸå€¼å‡ ä½•å…³é”®ç‚¹ï¼ˆæ‹ç‚¹ï¼‰
7. **Pred KP Geo** - é¢„æµ‹å‡ ä½•å…³é”®ç‚¹
8. **GT Tangent** - çœŸå€¼åˆ‡å‘åœºï¼ˆHSVï¼‰
9. **Pred Tangent** - é¢„æµ‹åˆ‡å‘åœº
10. **GT Width** - çœŸå€¼å®½åº¦ï¼ˆåªåœ¨éª¨æ¶ä¸Šæ˜¾ç¤ºï¼‰
11. **Pred Width** - é¢„æµ‹å®½åº¦
12. **GT Offset X** - çœŸå€¼ X æ–¹å‘åç§»
13. **Pred Offset X** - é¢„æµ‹ X æ–¹å‘åç§»
14. **GT Offset Y** - çœŸå€¼ Y æ–¹å‘åç§»
15. **Pred Offset Y** - é¢„æµ‹ Y æ–¹å‘åç§»
16. **Overlay** - å åŠ å›¾ï¼ˆç»¿=GTï¼Œçº¢=Predï¼Œé»„=é‡å ï¼‰

---

## ğŸ”§ **ä»£ç ä¿®æ”¹**

### 1. vis_core.py

æ–°å¢å‡½æ•° `create_dense_grid_image()`:
- ä¸“é—¨ç”¨äº Dense é˜¶æ®µçš„å®Œæ•´å¯è§†åŒ–
- è¾“å‡º 16 åˆ—å¯¹æ¯”å›¾
- åŒ…å«æ‰€æœ‰ 5 ä¸ªé¢„æµ‹å¤´çš„å¯¹æ¯”

### 2. lightning_vis.py

ä¿®æ”¹ `VisualizationCallback`:
- æ–°å¢å‚æ•° `use_dense_vis` (bool)
- æ ¹æ® `use_dense_vis` è‡ªåŠ¨é€‰æ‹©å¯è§†åŒ–å‡½æ•°

### 3. train_pl.py

è‡ªåŠ¨å¯ç”¨ Dense å¯è§†åŒ–:
```python
use_dense_vis = (stage_name == "dense")  # Dense é˜¶æ®µè‡ªåŠ¨å¯ç”¨
```

---

## ğŸ“ˆ **TensorBoard æ•ˆæœ**

### Structural é˜¶æ®µ

```
Validation/Visualization: 6 åˆ—å›¾åƒ
```

**åŒ…å«**:
- Skeleton å¯¹æ¯”
- Tangent å¯¹æ¯”
- Overlay

---

### Dense é˜¶æ®µ

```
Validation/Visualization: 16 åˆ—å›¾åƒ
```

**åŒ…å«**:
- âœ… Skeleton å¯¹æ¯”
- âœ… **Keypoints Topo å¯¹æ¯”** (æ–°å¢)
- âœ… **Keypoints Geo å¯¹æ¯”** (æ–°å¢)
- âœ… Tangent å¯¹æ¯”
- âœ… **Width å¯¹æ¯”** (æ–°å¢)
- âœ… **Offset X/Y å¯¹æ¯”** (æ–°å¢)
- âœ… Overlay

---

## ğŸ¯ **ä½¿ç”¨æ–¹æ³•**

### è‡ªåŠ¨å¯ç”¨ï¼ˆæ— éœ€é…ç½®ï¼‰

```bash
# Dense é˜¶æ®µè‡ªåŠ¨ä½¿ç”¨å®Œæ•´å¯è§†åŒ–
python train_pl.py --config configs/default.yaml --stage dense

# å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºï¼š
# ğŸ¨ Visualization: 4 samples (Dense (16 cols))
```

### æ‰‹åŠ¨æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä¸´æ—¶æ§åˆ¶å¯è§†åŒ–ç±»å‹ï¼š

```python
# æ–¹æ³• 1: ä¿®æ”¹ train_pl.py:376
use_dense_vis = (stage_name == "dense")  # æ”¹ä¸º True æˆ– False

# æ–¹æ³• 2: ç›´æ¥åœ¨è®­ç»ƒè„šæœ¬ä¸­æŒ‡å®š
# train_pl.py ä¸æ”¯æŒå‘½ä»¤è¡Œå‚æ•°ï¼Œéœ€è¦ä¿®æ”¹é…ç½®
```

---

## ğŸ“Š **å¯è§†åŒ–æ•ˆæœç¤ºä¾‹**

### Keypoints å¯¹æ¯”

**GT KP Topo (åˆ—4)**:
- çº¢è‰²çƒ­åŠ›å›¾
- æ˜¾ç¤ºç«¯ç‚¹ã€äº¤å‰ç‚¹
- é«˜æ–¯çƒ­åŠ›å›¾æ ¼å¼ï¼ˆsigma=2.0ï¼‰

**Pred KP Topo (åˆ—5)**:
- çº¢è‰²çƒ­åŠ›å›¾
- æ¨¡å‹é¢„æµ‹çš„æ‹“æ‰‘èŠ‚ç‚¹
- ç”¨äºè¯„ä¼°ç»“æ„ç†è§£èƒ½åŠ›

---

### Width å¯¹æ¯”

**GT W / Pr W (åˆ—10-11)**:
- åªåœ¨éª¨æ¶ä¸Šæ˜¾ç¤ºå®½åº¦ï¼ˆmask åï¼‰
- é¢œè‰²æ˜ å°„ï¼šviridis
- èŒƒå›´ï¼š0-5 åƒç´ 

**ç”¨é€”**ï¼š
- è¯„ä¼°å®½åº¦é¢„æµ‹å‡†ç¡®æ€§
- æ£€æŸ¥æ˜¯å¦é¢„æµ‹äº†ç¬”ç”»ç²—ç»†å˜åŒ–

---

### Offset å¯¹æ¯”

**GT OX / Pr OX (åˆ—12-13)**:
- X æ–¹å‘äºšåƒç´ åç§»
- åªåœ¨éª¨æ¶ä¸Šæ˜¾ç¤º
- é¢œè‰²æ˜ å°„ï¼šcoolwarm
- èŒƒå›´ï¼š-0.5 åˆ° 0.5

**GT OY / Pr OY (åˆ—14-15)**:
- Y æ–¹å‘äºšåƒç´ åç§»
- åŒä¸Š

**ç”¨é€”**ï¼š
- è¯„ä¼°äºšåƒç´ ç²¾åº¦
- æ£€æŸ¥æ˜¯å¦èƒ½ç»†åŒ–éª¨æ¶ä½ç½®

---

## âš™ï¸ **é…ç½®è°ƒæ•´**

### è°ƒæ•´å¯è§†åŒ–æ ·æœ¬æ•°

```yaml
# configs/default.yaml
stages:
  dense:
    training:
      visualization:
        enabled: true
        num_samples: 4    # å¯æ”¹ä¸º 2 (æ›´å¿«) æˆ– 8 (æ›´è¯¦ç»†)
        log_interval: 1
```

### TensorBoard æŸ¥çœ‹

```bash
# å¯åŠ¨ TensorBoard
tensorboard --logdir runs/

# æµè§ˆå™¨æ‰“å¼€
http://localhost:6006

# æŸ¥çœ‹ Images æ ‡ç­¾é¡µ
- Validation/Visualization: 16 åˆ—å®Œæ•´å¯¹æ¯”
- å¯ä»¥ä¸Šæ»šæŸ¥çœ‹ä¸åŒ epoch çš„å˜åŒ–
```

---

## ğŸ¯ **å…³é”®æ”¹è¿›**

### 1. å®Œæ•´çš„ 5 å¤´è¯„ä¼°

ä¹‹å‰åªèƒ½çœ‹åˆ° Skeleton å’Œ Tangentï¼Œç°åœ¨å¯ä»¥çœ‹åˆ°ï¼š
- âœ… Keypoints (Topo + Geo)
- âœ… Width
- âœ… Offset (X + Y)

### 2. æ›´å¥½çš„è°ƒè¯•èƒ½åŠ›

é€šè¿‡å¯¹æ¯”å›¾å¯ä»¥å¿«é€Ÿå‘ç°ï¼š
- Keypoints æ˜¯å¦æ¼æ£€ç«¯ç‚¹
- Width æ˜¯å¦é¢„æµ‹å‡†ç¡®
- Offset æ˜¯å¦ç»†åŒ–äº†éª¨æ¶
- Tangent æ–¹å‘æ˜¯å¦æ­£ç¡®

### 3. è‡ªåŠ¨åŒ–

æ— éœ€æ‰‹åŠ¨é…ç½®ï¼ŒDense é˜¶æ®µè‡ªåŠ¨å¯ç”¨å®Œæ•´å¯è§†åŒ–ã€‚

---

## ğŸ“ **æ³¨æ„äº‹é¡¹**

### æ€§èƒ½å½±å“

- **å›¾åƒå¤§å°**: 6åˆ— â†’ 16åˆ—ï¼Œæ–‡ä»¶å¤§å°å¢åŠ  ~2.5x
- **ç”Ÿæˆæ—¶é—´**: å¢åŠ  ~50%ï¼ˆmatplotlib ç»˜å›¾ï¼‰
- **ç£ç›˜å ç”¨**: TensorBoard æ—¥å¿—ä¼šæ›´å¤§

### ä¼˜åŒ–å»ºè®®

å¦‚æœè§‰å¾—å¤ªå¤§æˆ–å¤ªæ…¢ï¼š

```yaml
# æ–¹æ¡ˆ 1: å‡å°‘æ ·æœ¬æ•°
num_samples: 2  # 4 â†’ 2

# æ–¹æ¡ˆ 2: é™ä½å¯è§†åŒ–é¢‘ç‡
log_interval: 2  # æ¯ 2 ä¸ª epoch å¯è§†åŒ–ä¸€æ¬¡

# æ–¹æ¡ˆ 3: åªåœ¨å…³é”®é˜¶æ®µå¯ç”¨
# ä¿®æ”¹ train_pl.py:376
use_dense_vis = (stage_name == "dense" and trainer.current_epoch % 5 == 0)
```

---

## âœ… **æ€»ç»“**

| é¡¹ç›® | Structural | Dense |
|------|-----------|-------|
| **åˆ—æ•°** | 6 | **16** |
| **å†…å®¹** | Skel, Tan, Ovl | **Skel, KP(2), Tan, W, Off(2), Ovl** |
| **è‡ªåŠ¨å¯ç”¨** | å¦ | **æ˜¯** |
| **æ–‡ä»¶å¤§å°** | å° | **~2.5x** |
| **è°ƒè¯•èƒ½åŠ›** | åŸºç¡€ | **å®Œæ•´** |

ç°åœ¨ Dense é˜¶æ®µçš„ TensorBoard å¯è§†åŒ–ä¼šåŒ…å«**æ‰€æœ‰é¢„æµ‹å¤´çš„è¯¦ç»†å¯¹æ¯”**ï¼Œæ–¹ä¾¿ä½ å…¨é¢è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼ğŸ‰
